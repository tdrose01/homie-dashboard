<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homies Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a0f;
            --card: rgba(20, 20, 28, 0.7);
            --cyan: #00d4ff;
            --purple: #a855f7;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
            --error: #ef4444;
            --warn: #f59e0b;
            --ok: #22c55e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 20% 80%, rgba(0,212,255,0.03) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(168,85,247,0.03) 0%, transparent 50%);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }
        .glass { background: var(--card); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: opacity 0.3s; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header-actions { display:flex; gap:10px; align-items:center; }
        .btn { border:1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); border-radius: 8px; padding: 7px 12px; font-size: 12px; cursor: pointer; }
        .btn:hover { border-color: rgba(0,212,255,0.4); color: var(--cyan); }
        .logo-group { display:flex; align-items:center; gap:14px; }
        .logo-icon { width:48px; height:48px; flex-shrink:0; filter:drop-shadow(0 0 8px rgba(0,212,255,0.3)); }
        .logo-text { display:flex; flex-direction:column; gap:2px; }
        .logo-title { font-size:28px; font-weight:800; letter-spacing:0.1em; color:#fff; text-shadow:0 0 24px rgba(0,212,255,0.25); line-height:1; }
        .logo-subtitle { font-size:11px; font-weight:600; letter-spacing:0.3em; background:linear-gradient(90deg,var(--cyan),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; line-height:1; }
        .meta { display: flex; gap: 20px; align-items: center; font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--muted); }
        .live { color: var(--cyan); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--cyan); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
        .grid { display: grid; gap: 20px; margin-bottom: 24px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .status-row { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        @media (max-width: 1024px) { .status-row { grid-template-columns: repeat(2, 1fr); } .memory-panel { grid-column: 1 / -1 !important; } }
        @media (max-width: 640px) {
            .status-row { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .stat .val { font-size: 22px; margin: 4px 0; }
            .grid { grid-template-columns: 1fr; gap: 12px; }
            .glass { padding: 15px; }
            .meta { gap: 12px; font-size: 12px; }
            .action-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
            .action-btn { font-size: 11px; padding: 8px; text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; }
        }
        .stat { text-align: center; }
        .stat .val { font-family: 'JetBrains Mono', monospace; font-size: 28px; font-weight: 500; color: var(--cyan); margin: 8px 0; }
        .spark { display:block; margin:2px auto 0; opacity:.6; }
        .stat .lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); }
        .panel-header { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .panel-header .pulse { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .pulse.green { background: var(--ok); }
        .pulse.amber { background: var(--warn); }
        .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .row:last-child { border-bottom: none; }
        .row .lbl { color: var(--muted); font-size: 13px; }
        .row .val { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .row .val.error { color: var(--error); }
        .provider { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; }
        .badge { padding: 3px 10px; border-radius: 20px; font-size: 10px; text-transform: uppercase; font-weight: 600; }
        .badge.ok { background: rgba(34,197,94,0.2); color: var(--ok); }
        .badge.missing { background: rgba(239,68,68,0.2); color: var(--error); }
        .skills { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
        .skill { padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 500; text-align: center; transition: transform 0.2s; }
        .skill:hover { transform: translateY(-2px); }
        .skill.installed { background: rgba(0,212,255,0.15); color: var(--cyan); }
        .skill.missing { background: rgba(255,255,255,0.05); color: var(--muted); }
        .memory-content { font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; max-height: 300px; overflow-y: auto; white-space: pre-wrap; color: var(--muted); }
        .mem-search { width:100%; padding:7px 10px 7px 30px; border:1px solid var(--border); background:rgba(255,255,255,0.04); color:var(--text); border-radius:8px; font-size:12px; font-family:'JetBrains Mono',monospace; margin-bottom:10px; outline:none; transition:border-color .2s; }
        .mem-search:focus { border-color:rgba(0,212,255,0.4); }
        .mem-search-wrap { position:relative; }
        .mem-search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:12px; pointer-events:none; }
        .mem-highlight { background:rgba(0,212,255,0.25); border-radius:2px; padding:0 1px; }
        .mem-count { font-size:11px; color:var(--muted); margin-bottom:6px; font-family:'JetBrains Mono',monospace; }
        .memory-content::-webkit-scrollbar { width: 6px; }
        .memory-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .date-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .chip { padding: 4px 10px; border-radius: 20px; font-size: 11px; background: rgba(255,255,255,0.05); color: var(--muted); cursor: pointer; transition: all 0.2s; }
        .chip:hover, .chip.active { background: var(--cyan); color: #000; }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab { padding: 8px 16px; font-size: 14px; font-weight: 500; color: var(--muted); background: transparent; border: none; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .tab:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab.active { background: rgba(0,212,255,0.15); color: var(--cyan); border-bottom: 2px solid var(--cyan); border-bottom-left-radius: 0; border-bottom-right-radius: 0; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab { position:relative; }
        .tab-badge { position:absolute; top:2px; right:2px; min-width:16px; height:16px; border-radius:8px; background:var(--cyan); color:#000; font-size:9px; font-weight:700; display:flex; align-items:center; justify-content:center; padding:0 4px; box-shadow:0 0 6px var(--cyan); }
        .confirm-overlay { position:fixed; inset:0; z-index:9998; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; animation:fadeIn .2s; }
        .confirm-box { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:24px 28px; max-width:380px; width:90%; backdrop-filter:blur(16px); box-shadow:0 8px 32px rgba(0,0,0,0.4); }
        .confirm-title { font-size:15px; font-weight:600; margin-bottom:8px; }
        .confirm-msg { font-size:13px; color:var(--muted); margin-bottom:20px; line-height:1.5; }
        .confirm-actions { display:flex; gap:10px; justify-content:flex-end; }
        .confirm-actions .btn { padding:8px 18px; font-size:13px; }
        .confirm-actions .btn.danger { border-color:rgba(239,68,68,0.4); color:var(--error); }
        .confirm-actions .btn.danger:hover { background:rgba(239,68,68,0.15); }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .agent-grid.tree-view { display:flex; flex-direction:column; gap:0; }
        .tree-node { margin-bottom:16px; }
        .tree-root { box-shadow:inset 3px 0 0 var(--cyan); }
        .tree-children { margin-left:28px; padding-left:16px; border-left:2px solid rgba(0,212,255,0.15); display:flex; flex-direction:column; gap:10px; margin-top:10px; }
        .tree-leaf { padding:12px 14px; gap:8px; }
        .tree-leaf .agent-header { border-bottom:none; padding-bottom:0; }
        .tree-leaf .agent-body { font-size:11px; gap:5px; }
        .tree-child-count { font-size:10px; background:rgba(0,212,255,0.15); color:var(--cyan); padding:2px 8px; border-radius:10px; }
        .agent-card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .agent-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .agent-name { font-size: 14px; font-weight: 600; color: #fff; }
        .agent-type { font-size: 11px; text-transform: uppercase; color: var(--cyan); background: rgba(0,212,255,0.1); padding: 3px 8px; border-radius: 12px; }
        .agent-body { display: flex; flex-direction: column; gap: 8px; font-size: 12px; }
        .agent-row { display: flex; justify-content: space-between; }
        .agent-lbl { color: var(--muted); }
        .agent-val { font-family: 'JetBrains Mono', monospace; }
        .agent-status { display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.idle { background: var(--muted); }
        .status-dot.working { background: var(--cyan); box-shadow: 0 0 8px var(--cyan); }
        .status-dot.error { background: var(--error); box-shadow: 0 0 8px var(--error); }
        .issues-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
        .alert-card { position:relative; background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:10px; padding:14px 16px; display:flex; flex-direction:column; gap:10px; transition:transform 0.2s, box-shadow 0.2s; }
        .alert-dismiss { position:absolute; top:8px; right:8px; width:22px; height:22px; border-radius:50%; border:1px solid var(--border); background:rgba(255,255,255,0.06); color:var(--muted); font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity .2s; line-height:1; }
        .alert-card:hover .alert-dismiss { opacity:1; }
        .alert-dismiss:hover { background:rgba(255,255,255,0.15); color:var(--text); border-color:rgba(255,255,255,0.2); }
        .alert-card:hover { transform:translateY(-2px); box-shadow:0 4px 20px rgba(0,0,0,0.2); }
        .alert-card.error { border-top:2px solid var(--error); }
        .alert-card.warning { border-top:2px solid var(--warn); }
        .alert-head { display:flex; align-items:center; gap:8px; }
        .alert-icon { width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:600; flex-shrink:0; }
        .alert-card.error .alert-icon { background:rgba(239,68,68,0.15); color:var(--error); }
        .alert-card.warning .alert-icon { background:rgba(245,158,11,0.15); color:var(--warn); }
        .alert-badge { font-size:10px; text-transform:uppercase; font-weight:600; letter-spacing:0.05em; }
        .alert-card.error .alert-badge { color:var(--error); }
        .alert-card.warning .alert-badge { color:var(--warn); }
        .alert-msg { font-family:'JetBrains Mono',monospace; font-size:12px; line-height:1.5; color:var(--muted); word-break:break-word; }
        @media (max-width: 640px) { .issues-container { grid-template-columns:1fr; } }
        .nominal { padding: 20px; text-align: center; color: var(--ok); font-size: 14px; }
        .provider-name { font-weight: 500; }
        .provider-msg { font-size: 11px; color: var(--muted); margin-right: 8px; }
        .progress-wrap { margin-bottom: 12px; }
        .progress-row { display:flex; justify-content:space-between; font-family:'JetBrains Mono',monospace; font-size:12px; margin-bottom:8px; color:var(--muted); }
        .progress-bar { height:8px; border-radius:999px; background:rgba(255,255,255,0.08); overflow:hidden; }
        .progress-fill { height:100%; width:0%; background:linear-gradient(90deg,var(--cyan),var(--purple)); transition:width .3s ease; }
        .todo-list { font-size:13px; display:flex; flex-direction:column; gap:12px; }
        .todo-project { padding:10px; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid var(--border); }
        .todo-project-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; cursor:pointer; padding: 4px; border-radius: 4px; transition: background 0.2s; }
        .todo-project-head:hover { background: rgba(255,255,255,0.08); }
        .todo-items { display:none; flex-direction:column; gap:8px; margin-top: 8px; }
        .todo-project.active .todo-items { display:flex; }
        .accordion-icon { transition: transform 0.2s; display: inline-block; width: 12px; }
        .todo-project.active .accordion-icon { transform: rotate(90deg); }
        .todo-project-name { font-weight:600; color:var(--cyan); }
        .todo-project-meta { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--muted); }

        .todo-item { padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.04); }
        .todo-item.done { opacity:.65; text-decoration:line-through; }
        .action-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:10px; }
        .action-btn { text-align:center; display: flex; align-items: center; justify-content: center; font-size:12px; padding:10px 12px; border:1px solid var(--border); background:rgba(255,255,255,0.04); color:var(--text); border-radius:8px; cursor:pointer; min-height: 44px; }
        .action-btn:hover { border-color: rgba(0,212,255,0.4); color: var(--cyan); }
        .action-btn:disabled { opacity:0.5; cursor:not-allowed; }
        .action-result { margin-top:10px; font-family:'JetBrains Mono',monospace; font-size:12px; white-space:pre-wrap; color:var(--muted); background:rgba(0,0,0,.2); border:1px solid var(--border); border-radius:8px; padding:10px; min-height:44px; max-height:250px; overflow-y:auto; }

        @media (max-width: 640px) {
            .action-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
            .action-btn { font-size: 11px; padding: 8px; min-height: 50px; }
        }

        /* V3: Ops Intel */
        .cost-row { grid-column:1/-1; display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
        @media (max-width:640px) { .cost-row { grid-template-columns:1fr; gap:10px; } }
        .model-table { width:100%; border-collapse:collapse; font-size:13px; }
        .model-table th { text-align:left; font-size:10px; text-transform:uppercase; letter-spacing:0.06em; color:var(--muted); padding:8px 12px; border-bottom:1px solid var(--border); }
        .model-table td { padding:8px 12px; border-bottom:1px solid var(--border); font-family:'JetBrains Mono',monospace; font-size:12px; }
        .model-table tr:last-child td { border-bottom:none; }
        .model-table .mn { font-family:'Inter',sans-serif; font-weight:500; color:var(--text); }
        .gauge { margin-bottom:14px; }
        .gauge:last-child { margin-bottom:0; }
        .gauge-head { display:flex; justify-content:space-between; font-size:13px; margin-bottom:6px; }
        .gauge-provider { font-weight:500; }
        .gauge-pct { font-family:'JetBrains Mono',monospace; color:var(--muted); }
        .gauge-bar { height:8px; border-radius:999px; background:rgba(255,255,255,0.08); overflow:hidden; }
        .gauge-fill { height:100%; border-radius:999px; transition:width .3s; }
        .gauge-fill.ok { background:var(--ok); }
        .gauge-fill.warn { background:var(--warn); }
        .gauge-fill.danger { background:var(--error); }
        .gauge-meta { font-size:11px; color:var(--muted); margin-top:4px; font-family:'JetBrains Mono',monospace; }
        .cron-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
        .cron-card { background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:10px; padding:14px 16px; display:flex; align-items:center; gap:12px; }
        .cron-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .cron-dot.active { background:var(--cyan); box-shadow:0 0 6px var(--cyan); }
        .cron-dot.idle { background:var(--muted); }
        .cron-dot.error { background:var(--error); box-shadow:0 0 6px var(--error); }
        .cron-info { flex:1; min-width:0; }
        .cron-name { font-weight:600; font-size:13px; margin-bottom:2px; }
        .cron-meta { font-size:11px; color:var(--muted); font-family:'JetBrains Mono',monospace; }
        .feed { max-height:350px; overflow-y:auto; }
        .feed::-webkit-scrollbar { width:4px; }
        .feed::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
        .feed-entry { display:flex; align-items:flex-start; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); font-size:12px; }
        .feed-entry:last-child { border-bottom:none; }
        .feed-time { font-family:'JetBrains Mono',monospace; color:var(--muted); flex-shrink:0; font-size:11px; min-width:55px; }
        .feed-dot { flex-shrink:0; width:6px; height:6px; border-radius:50%; margin-top:5px; }
        .feed-dot.green { background:var(--ok); } .feed-dot.red { background:var(--error); }
        .feed-dot.amber { background:var(--warn); } .feed-dot.cyan { background:var(--cyan); }
        .feed-dot.purple { background:var(--purple); }
        .feed-msg { color:var(--muted); line-height:1.4; word-break:break-word; }
        .feed-date { font-size:11px; color:var(--muted); opacity:.6; padding:10px 0 4px; font-family:'JetBrains Mono',monospace; }

        /* Cost history chart */
        .chart-wrap { position:relative; width:100%; height:180px; }
        .chart-svg { width:100%; height:100%; }
        .chart-bar { transition:opacity .2s; cursor:pointer; }
        .chart-bar:hover { opacity:0.8; }
        .chart-gridline { stroke:var(--border); stroke-width:0.5; }
        .chart-label { font-family:'JetBrains Mono',monospace; font-size:9px; fill:var(--muted); }
        .chart-tooltip { position:absolute; pointer-events:none; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:8px 12px; font-size:12px; font-family:'JetBrains Mono',monospace; backdrop-filter:blur(12px); box-shadow:0 4px 16px rgba(0,0,0,0.3); white-space:nowrap; z-index:10; opacity:0; transition:opacity .15s; }
        .chart-tooltip.visible { opacity:1; }
        .chart-tooltip-date { color:var(--cyan); font-weight:600; margin-bottom:3px; }
        .chart-tooltip-val { color:var(--text); }
        .chart-tooltip-tok { color:var(--muted); font-size:11px; }
        .chart-empty { height:180px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:13px; }
        body.compact .chart-wrap { height:130px; }
        body.compact .chart-empty { height:130px; }
        body.light .chart-tooltip { box-shadow:0 4px 16px rgba(0,0,0,0.1); }

        /* Toast notifications */
        #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; max-width:380px; }
        .toast { pointer-events:auto; padding:12px 16px; border-radius:10px; font-size:13px; font-family:'Inter',sans-serif; backdrop-filter:blur(16px); border:1px solid var(--border); color:var(--text); animation:toastIn .3s ease forwards; display:flex; align-items:center; gap:10px; box-shadow:0 4px 24px rgba(0,0,0,0.3); }
        .toast.error { background:rgba(239,68,68,0.15); border-color:rgba(239,68,68,0.3); }
        .toast.warn { background:rgba(245,158,11,0.15); border-color:rgba(245,158,11,0.3); }
        .toast.info { background:rgba(0,212,255,0.12); border-color:rgba(0,212,255,0.25); }
        .toast.out { animation:toastOut .3s ease forwards; }
        .toast-icon { flex-shrink:0; font-size:15px; }
        @keyframes toastIn { from{opacity:0;transform:translateX(40px)} to{opacity:1;transform:translateX(0)} }
        @keyframes toastOut { from{opacity:1;transform:translateX(0)} to{opacity:0;transform:translateX(40px)} }

        /* Skeleton loading */
        .skel { background:rgba(255,255,255,0.04); border-radius:6px; position:relative; overflow:hidden; }
        .skel::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.04),transparent); animation:shimmer 1.5s infinite; }
        @keyframes shimmer { from{transform:translateX(-100%)} to{transform:translateX(100%)} }
        .skel-line { height:14px; margin-bottom:10px; }
        .skel-card { height:44px; border-radius:8px; margin-bottom:8px; }
        .skel-block { height:34px; border-radius:8px; }

        /* Gateway health card */
        .gw-health { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
        .gw-metric { text-align:center; flex:1; min-width:80px; }
        .gw-metric .gw-val { font-family:'JetBrains Mono',monospace; font-size:22px; font-weight:500; margin:6px 0; text-transform:capitalize; }
        .gw-metric .gw-lbl { font-size:10px; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); }
        .gw-val.st-active { color:var(--ok); }
        .gw-val.st-inactive, .gw-val.st-failed, .gw-val.st-deactivating { color:var(--error); }
        .gw-val.st-activating, .gw-val.st-reloading { color:var(--warn); }
        .gw-val.st-unknown { color:var(--muted); }

        /* Compact mode toggle */
        .compact-toggle { display:flex; align-items:center; gap:6px; }
        .toggle-track { width:34px; height:18px; border-radius:9px; background:rgba(255,255,255,0.08); border:1px solid var(--border); cursor:pointer; position:relative; transition:all .2s; flex-shrink:0; }
        .toggle-track.on { background:rgba(0,212,255,0.2); border-color:rgba(0,212,255,0.4); }
        .toggle-thumb { width:14px; height:14px; border-radius:50%; background:var(--muted); position:absolute; top:1px; left:1px; transition:all .2s; }
        .toggle-track.on .toggle-thumb { left:17px; background:var(--cyan); }
        .compact-lbl { font-size:11px; color:var(--muted); cursor:pointer; }

        /* Compact mode */
        body.compact { padding:12px; }
        body.compact .glass { padding:12px; border-radius:8px; }
        body.compact .grid { gap:10px; }
        body.compact .stat .val { font-size:20px; margin:4px 0; }
        body.compact .stat .lbl { font-size:10px; }
        body.compact .panel-header { font-size:11px; margin-bottom:10px; }
        body.compact .provider { padding:6px 10px; margin-bottom:6px; }
        body.compact .skill { padding:5px 8px; font-size:11px; }
        body.compact .skills { gap:6px; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); }
        body.compact .memory-content { max-height:180px; font-size:11px; line-height:1.4; }
        body.compact .mem-search { padding:5px 8px 5px 26px; font-size:11px; }
        body.compact .row { padding:6px 0; }
        body.compact .row .lbl, body.compact .row .val { font-size:12px; }
        body.compact .alert-card { padding:10px 12px; gap:6px; }
        body.compact .alert-msg { font-size:11px; }
        body.compact .alert-icon { width:24px; height:24px; font-size:11px; }
        body.compact .todo-item { padding:5px 8px; font-size:12px; }
        body.compact .action-btn { padding:6px 8px; font-size:11px; min-height:36px; }
        body.compact .action-result { font-size:11px; padding:8px; min-height:32px; max-height:150px; }
        body.compact header { margin-bottom:14px; }
        body.compact .logo-icon { width:34px; height:34px; }
        body.compact .logo-title { font-size:20px; }
        body.compact .logo-subtitle { font-size:9px; letter-spacing:0.2em; }
        body.compact .logo-group { gap:10px; }
        body.compact .meta { font-size:11px; gap:8px; }
        body.compact .tabs { margin-bottom:12px; padding-bottom:8px; }
        body.compact .tab { padding:6px 10px; font-size:12px; }
        body.compact .status-row { gap:10px; }
        body.compact .agent-card { padding:10px; gap:6px; }
        body.compact .agent-name { font-size:12px; }
        body.compact .agent-body { font-size:11px; gap:5px; }
        body.compact .tree-children { margin-left:20px; padding-left:12px; gap:8px; margin-top:8px; }
        body.compact .tree-node { margin-bottom:12px; }
        body.compact .gw-metric .gw-val { font-size:18px; }
        body.compact .date-chips { gap:4px; }
        body.compact .chip { padding:3px 8px; font-size:10px; }
        body.compact .cost-row { gap:10px; }
        body.compact .model-table { font-size:11px; }
        body.compact .model-table th, body.compact .model-table td { padding:5px 8px; }
        body.compact .gauge { margin-bottom:10px; }
        body.compact .gauge-head { font-size:12px; }
        body.compact .cron-card { padding:10px 12px; }
        body.compact .cron-name { font-size:12px; }
        body.compact .feed { max-height:250px; }
        body.compact .feed-entry { font-size:11px; padding:6px 0; }
        @media (max-width: 640px) {
            .compact-lbl { display:none; }
            .logo-icon { width:36px; height:36px; }
            .logo-title { font-size:22px; }
            .logo-subtitle { font-size:10px; letter-spacing:0.2em; }
            .logo-group { gap:10px; }
        }

        /* Light theme */
        body.light {
            --bg: #f0f2f5;
            --card: rgba(255,255,255,0.85);
            --text: #1e293b;
            --muted: #64748b;
            --border: rgba(0,0,0,0.1);
            background: var(--bg);
            background-image: radial-gradient(circle at 20% 80%, rgba(0,180,255,0.07) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(168,85,247,0.07) 0%, transparent 50%);
        }
        body.light .glass { box-shadow:0 1px 4px rgba(0,0,0,0.06); }
        body.light .logo-title { color:#1e293b; text-shadow:none; }
        body.light .logo-icon { filter:drop-shadow(0 0 6px rgba(0,100,200,0.2)); }
        body.light .provider,
        body.light .alert-card,
        body.light .agent-card { background:rgba(0,0,0,0.03); }
        body.light .tree-children { border-color:rgba(0,100,200,0.15); }
        body.light .tree-root { box-shadow:inset 3px 0 0 #0088cc; }
        body.light .action-result { background:rgba(0,0,0,0.03); }
        body.light .skill.installed { background:rgba(0,140,210,0.1); }
        body.light .skill.missing { background:rgba(0,0,0,0.04); }
        body.light .todo-project { background:rgba(0,0,0,0.02); }
        body.light .todo-item { background:rgba(0,0,0,0.03); }
        body.light .action-btn { background:rgba(0,0,0,0.03); }
        body.light .btn { background:rgba(0,0,0,0.04); }
        body.light .chip { background:rgba(0,0,0,0.06); }
        body.light .skel { background:rgba(0,0,0,0.06); }
        body.light .skel::after { background:linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent); }
        body.light .toggle-track { background:rgba(0,0,0,0.1); }
        body.light .toast { box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        body.light .toast.error { background:rgba(239,68,68,0.1); }
        body.light .toast.warn { background:rgba(245,158,11,0.1); }
        body.light .toast.info { background:rgba(0,140,210,0.08); }
        body.light .memory-content::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.15); }
        body.light .mem-search { background:rgba(0,0,0,0.04); }
        body.light .mem-highlight { background:rgba(0,140,210,0.2); }
        body.light .alert-dismiss { background:rgba(0,0,0,0.05); border-color:rgba(0,0,0,0.1); }
        body.light .alert-dismiss:hover { background:rgba(0,0,0,0.1); color:var(--text); }
        body.light .cron-card { background:rgba(0,0,0,0.03); }
        body.light .gauge-bar { background:rgba(0,0,0,0.08); }
        body.light .feed::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.12); }
        body.light .model-table td { border-color:rgba(0,0,0,0.06); }
        body.light .model-table th { border-color:rgba(0,0,0,0.08); }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <header>
        <div class="logo-group">
            <svg class="logo-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="lg1" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#00eaff"/><stop offset="1" stop-color="#0055cc"/>
                    </linearGradient>
                    <linearGradient id="lg2" x1="32" y1="0" x2="32" y2="64" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#00d4ff"/><stop offset="1" stop-color="#a855f7"/>
                    </linearGradient>
                    <filter id="glo"><feGaussianBlur stdDeviation="1.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <path d="M32 3 L56 17 L56 47 L32 61 L8 47 L8 17 Z" stroke="url(#lg2)" stroke-width="1.5" fill="rgba(0,180,255,0.06)"/>
                <path d="M32 5 L37 19 L32 25 L27 19 Z" fill="url(#lg1)" filter="url(#glo)"/>
                <path d="M18 12 L26 23 L21 31 L13 20 Z" fill="url(#lg1)" opacity=".75"/>
                <path d="M46 12 L38 23 L43 31 L51 20 Z" fill="url(#lg1)" opacity=".75"/>
                <path d="M10 22 L19 28 L15 36 L7 30 Z" fill="url(#lg1)" opacity=".5"/>
                <path d="M54 22 L45 28 L49 36 L57 30 Z" fill="url(#lg1)" opacity=".5"/>
                <path d="M32 23 L42 35 L32 45 L22 35 Z" fill="url(#lg2)" opacity=".3"/>
                <path d="M32 23 L42 35 L32 45 L22 35 Z" stroke="url(#lg1)" stroke-width="1" fill="none"/>
                <circle cx="32" cy="51" r="4" fill="url(#lg1)" filter="url(#glo)"/>
                <circle cx="19" cy="43" r="3" fill="url(#lg1)" opacity=".7"/>
                <circle cx="45" cy="43" r="3" fill="url(#lg1)" opacity=".7"/>
                <line x1="19" y1="43" x2="32" y2="51" stroke="url(#lg1)" stroke-width="1.5" opacity=".5"/>
                <line x1="45" y1="43" x2="32" y2="51" stroke="url(#lg1)" stroke-width="1.5" opacity=".5"/>
                <line x1="19" y1="43" x2="45" y2="43" stroke="url(#lg1)" stroke-width="1" opacity=".25"/>
            </svg>
            <div class="logo-text">
                <div class="logo-title">HOMIES</div>
                <div class="logo-subtitle">&middot;&middot; DASHBOARD &middot;&middot;</div>
            </div>
        </div>
        <div class="meta">
            <span class="live" id="clock">--:--:--</span>
            <span id="last-refresh">--:--:--</span>
            <div style="display:flex;align-items:center;gap:8px;">
                <div class="dot"></div>
                <span id="countdown">30s</span>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="load()">Refresh now</button>
                <button class="btn" onclick="downloadSnapshot()" title="Download system snapshot">&#8615; Snapshot</button>
                <button class="btn" id="theme-btn" onclick="toggleTheme()" title="Toggle light/dark theme" style="font-size:14px;padding:5px 10px">&#9788;</button>
                <div class="compact-toggle" title="Compact mode">
                    <span class="compact-lbl" onclick="toggleCompact()">Compact</span>
                    <div id="compact-track" class="toggle-track" onclick="toggleCompact()">
                        <div class="toggle-thumb"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">System Overview</button>
        <button class="tab" onclick="switchTab('agents')">Agent Fleet<span id="agent-badge" class="tab-badge" style="display:none"></span></button>
        <button class="tab" onclick="switchTab('ops')">Ops Intel<span id="ops-badge" class="tab-badge" style="display:none;background:var(--warn);color:#000;box-shadow:0 0 6px var(--warn)"></span></button>
    </div>

    <div id="tab-overview" class="tab-content active">
        <div class="grid">
            <div class="status-row">
            <div class="glass stat"><div class="lbl">CPU</div><div class="val" id="cpu">--%</div></div>
            <div class="glass stat"><div class="lbl">RAM</div><div class="val" id="ram">-- / -- GB</div></div>
            <div class="glass stat"><div class="lbl">Disk</div><div class="val" id="disk">-- / -- GB</div></div>
            <div class="glass stat"><div class="lbl">Uptime</div><div class="val" id="uptime">--</div></div>
        </div>

        <div class="glass">
            <div class="panel-header"><div class="pulse green" id="gw-pulse"></div>Gateway Health</div>
            <div class="gw-health" id="gw-health">
                <div class="gw-metric"><div class="gw-lbl">Status</div><div class="skel" style="height:28px;width:80px;margin:6px auto;border-radius:6px"></div></div>
                <div class="gw-metric"><div class="gw-lbl">Restarts</div><div class="skel" style="height:28px;width:40px;margin:6px auto;border-radius:6px"></div></div>
                <div class="gw-metric"><div class="gw-lbl">Uptime</div><div class="skel" style="height:28px;width:70px;margin:6px auto;border-radius:6px"></div></div>
                <div class="gw-metric"><div class="gw-lbl">Last Probe</div><div class="skel" style="height:28px;width:80px;margin:6px auto;border-radius:6px"></div></div>
            </div>
        </div>

        <div class="glass">
            <div class="panel-header"><div class="pulse green" id="monitor-pulse"></div>Monitor State</div>
            <div class="row"><span class="lbl">Last Check</span><span class="val" id="last-check">--</span></div>
            <div class="row"><span class="lbl">Rate Limits</span><span class="val" id="rate-limits">--</span></div>
            <div class="row"><span class="lbl">Last Alert</span><span class="val" id="last-alert">--</span></div>
        </div>

        <div class="glass">
            <div class="panel-header">Provider Status</div>
            <div id="providers" style="font-size:12px;">
                <div class="skel skel-card"></div>
                <div class="skel skel-card"></div>
                <div class="skel skel-card"></div>
            </div>
        </div>

        <div class="glass" style="grid-column: 1 / -1;">
            <div class="panel-header">Skills Inventory</div>
            <div class="skills" id="skills">
                <div class="skel skel-block"></div><div class="skel skel-block"></div><div class="skel skel-block"></div><div class="skel skel-block"></div>
                <div class="skel skel-block"></div><div class="skel skel-block"></div><div class="skel skel-block"></div><div class="skel skel-block"></div>
            </div>
        </div>

        <div class="glass memory-panel" style="grid-column: span 2;">
            <div class="panel-header">Memory Log <span id="mem-date" style="color:var(--cyan);"></span></div>
            <div class="date-chips" id="date-chips"></div>
            <div class="mem-search-wrap"><span class="mem-search-icon">&#8981;</span><input class="mem-search" id="mem-search" type="text" placeholder="Filter memory log..." oninput="filterMemory()"></div>
            <div id="mem-count" class="mem-count" style="display:none"></div>
            <div class="memory-content" id="memory-content">
                <div class="skel skel-line" style="width:92%"></div>
                <div class="skel skel-line" style="width:78%"></div>
                <div class="skel skel-line" style="width:85%"></div>
                <div class="skel skel-line" style="width:60%"></div>
                <div class="skel skel-line" style="width:70%"></div>
            </div>
        </div>

        <div class="glass" style="grid-column: 1 / -1;">
            <div class="panel-header">Alerts Panel <span id="alerts-controls" style="margin-left:auto;display:flex;gap:6px;align-items:center"></span></div>
            <div id="issues" class="issues-container">
                <div class="skel" style="height:80px;border-radius:10px"></div>
                <div class="skel" style="height:80px;border-radius:10px"></div>
                <div class="skel" style="height:80px;border-radius:10px"></div>
            </div>
        </div>

        <div class="glass" style="grid-column: 1 / -1;">
            <div class="panel-header">Action Center</div>
            <div id="action-grid" class="action-grid">
                <div class="skel" style="height:44px;border-radius:8px"></div>
                <div class="skel" style="height:44px;border-radius:8px"></div>
                <div class="skel" style="height:44px;border-radius:8px"></div>
            </div>
            <div id="action-result" class="action-result">No actions run yet.</div>
        </div>

        <div class="glass" style="grid-column: 1 / -1;">
            <div class="panel-header">TODO / Progress</div>
            <div class="progress-wrap">
                <div class="progress-row"><span id="todo-summary">0 / 0 done</span><span id="todo-percent">0%</span></div>
                <div class="progress-bar"><div class="progress-fill" id="todo-fill"></div></div>
            </div>
            <div class="todo-list" id="todo-list">
                <div class="skel" style="height:50px;border-radius:10px"></div>
                <div class="skel" style="height:50px;border-radius:10px;margin-top:4px"></div>
            </div>
        </div>
    </div>

    </div>

    <div id="tab-agents" class="tab-content">
        <div class="agent-grid" id="agent-grid">
            <div class="skel" style="height:160px;border-radius:12px"></div>
            <div class="skel" style="height:160px;border-radius:12px"></div>
        </div>
    </div>

    <div id="tab-ops" class="tab-content">
        <div class="grid">
            <div class="cost-row">
                <div class="glass stat"><div class="lbl">Today Cost</div><div class="val" id="cost-today">--</div><div class="lbl" id="cost-today-tok"></div></div>
                <div class="glass stat"><div class="lbl">All-Time Cost</div><div class="val" id="cost-alltime">--</div><div class="lbl" id="cost-alltime-tok"></div></div>
                <div class="glass stat"><div class="lbl">Monthly Est.</div><div class="val" id="cost-monthly" style="color:var(--purple)">--</div><div class="lbl" id="cost-sessions"></div></div>
            </div>

            <div class="glass" style="grid-column:1/-1;">
                <div class="panel-header">Daily Cost History</div>
                <div id="cost-chart">
                    <div class="chart-empty">Collecting data...</div>
                </div>
            </div>

            <div class="glass" style="grid-column:1/-1;">
                <div class="panel-header">Cost Breakdown by Model</div>
                <div id="model-breakdown">
                    <div class="skel" style="height:36px;border-radius:6px;margin-bottom:8px"></div>
                    <div class="skel" style="height:36px;border-radius:6px;margin-bottom:8px"></div>
                    <div class="skel" style="height:36px;border-radius:6px"></div>
                </div>
            </div>

            <div class="glass" style="grid-column:1/-1;">
                <div class="panel-header">Rate Limits</div>
                <div id="rate-limits-panel">
                    <div class="skel" style="height:40px;border-radius:6px;margin-bottom:10px"></div>
                    <div class="skel" style="height:40px;border-radius:6px"></div>
                </div>
            </div>

            <div class="glass" style="grid-column:1/-1;">
                <div class="panel-header">Cron Jobs</div>
                <div id="cron-panel" class="cron-grid">
                    <div class="skel" style="height:60px;border-radius:10px"></div>
                    <div class="skel" style="height:60px;border-radius:10px"></div>
                    <div class="skel" style="height:60px;border-radius:10px"></div>
                </div>
            </div>

            <div class="glass" style="grid-column:1/-1;">
                <div class="panel-header">Live Activity Feed</div>
                <div id="feed-panel" class="feed">
                    <div class="skel skel-line" style="width:90%"></div>
                    <div class="skel skel-line" style="width:75%"></div>
                    <div class="skel skel-line" style="width:85%"></div>
                    <div class="skel skel-line" style="width:65%"></div>
                    <div class="skel skel-line" style="width:80%"></div>
                </div>
            </div>
        </div>
    </div>

<script>
let currentTab = 'overview';
const API_BASE = window.location.pathname.startsWith("/dashboard") ? "/dashboard/api" : "/api";

const _recentToasts = new Map();
function showToast(message, type = 'error') {
    const key = type + ':' + message;
    const now = Date.now();
    if (_recentToasts.has(key) && now - _recentToasts.get(key) < 10000) return;
    _recentToasts.set(key, now);
    if (_recentToasts.size > 50) _recentToasts.delete(_recentToasts.keys().next().value);
    const container = document.getElementById('toast-container');
    if (container.children.length >= 3) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { error: '\u2715', warn: '\u26A0', info: '\u2139' };
    toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${escapeHtml(message)}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 4000);
}

function initCompact() {
    const isCompact = localStorage.getItem('homie-compact') === 'true';
    document.body.classList.toggle('compact', isCompact);
    const track = document.getElementById('compact-track');
    if (track) track.classList.toggle('on', isCompact);
}

function toggleCompact() {
    const isCompact = document.body.classList.toggle('compact');
    localStorage.setItem('homie-compact', String(isCompact));
    const track = document.getElementById('compact-track');
    if (track) track.classList.toggle('on', isCompact);
}

function initTheme() {
    const light = localStorage.getItem('homie-theme') === 'light';
    document.body.classList.toggle('light', light);
    const btn = document.getElementById('theme-btn');
    if (btn) btn.innerHTML = light ? '&#9790;' : '&#9788;';
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem('homie-theme', isLight ? 'light' : 'dark');
    const btn = document.getElementById('theme-btn');
    if (btn) btn.innerHTML = isLight ? '&#9790;' : '&#9788;';
}

function switchTab(tabId) {
    currentTab = tabId;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

    document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
    document.getElementById(`tab-${tabId}`).classList.add('active');

    if (tabId === 'agents') loadAgents();
    if (tabId === 'ops') loadOps();
}

function buildAgentTree(sessions) {
    const roots = [];
    const subs = [];
    for (const s of sessions) {
        if ((s.key || '').includes('cron:')) continue;
        if (s.ageMs >= 120000 && !s.abortedLastRun) continue;
        if (s.agentId === 'main' || !s.agentId || s.agentId === 'default') {
            roots.push({...s, children: []});
        } else {
            subs.push(s);
        }
    }
    for (const sub of subs) {
        let matched = false;
        if (sub.parentSessionId) {
            const p = roots.find(r => r.sessionId === sub.parentSessionId);
            if (p) { p.children.push(sub); matched = true; }
        }
        if (!matched) {
            const subBase = (sub.key || '').split('/')[0];
            const p = roots.find(r => {
                const rBase = (r.key || '').split('/')[0];
                return rBase && subBase && (rBase === subBase || subBase.startsWith(rBase));
            });
            if (p) { p.children.push(sub); matched = true; }
        }
        if (!matched) {
            if (roots.length > 0) roots[0].children.push(sub);
            else roots.push({...sub, children: []});
        }
    }
    return roots;
}

function agentCardHTML(s, isRoot) {
    const sessionId = s.sessionId || 'unknown';
    let typeName = 'Main Session';
    if (s.agentId && s.agentId !== 'main' && s.agentId !== 'default') typeName = `Sub-agent (${s.agentId})`;
    else if (s.kind === 'group') typeName = 'Group Chat';
    const isActive = s.ageMs < 120000;
    let stCls = isActive ? 'working' : 'idle', stTxt = isActive ? 'Working' : 'Idle';
    if (s.abortedLastRun) { stCls = 'error'; stTxt = 'Aborted / Error'; }
    const shortId = sessionId.length > 8 ? sessionId.substring(0, 8) + '...' + sessionId.slice(-4) : sessionId;
    const childCount = (s.children || []).length;
    return `<div class="agent-card ${isRoot ? 'tree-root' : 'tree-leaf'}">
        <div class="agent-header">
            <span class="agent-name" title="${escapeHtml(s.key || '')}">${escapeHtml(shortId)}</span>
            <div style="display:flex;align-items:center;gap:6px">
                ${childCount > 0 ? `<span class="tree-child-count">${childCount} sub</span>` : ''}
                <span class="agent-type">${escapeHtml(typeName)}</span>
            </div>
        </div>
        <div class="agent-body">
            <div class="agent-row"><span class="agent-lbl">Status</span><div class="agent-status"><div class="status-dot ${stCls}"></div><span class="agent-val">${escapeHtml(stTxt)}</span></div></div>
            <div class="agent-row"><span class="agent-lbl">Model</span><span class="agent-val">${escapeHtml(s.model || 'unknown')}</span></div>
            <div class="agent-row"><span class="agent-lbl">Tokens</span><span class="agent-val">${(s.totalTokens || 0).toLocaleString()}</span></div>
            <div class="agent-row"><span class="agent-lbl">Last Active</span><span class="agent-val">${fmtAge(s.ageMs)}</span></div>
        </div>
    </div>`;
}

async function loadAgents() {
    try {
        const r = await fetch(API_BASE + '/agents').then(r => r.json());
        if (!r.ok || !r.sessions) throw new Error(r.error || 'Failed to load agents');

        const grid = document.getElementById('agent-grid');
        const tree = buildAgentTree(r.sessions);
        const hasChildren = tree.some(n => (n.children || []).length > 0);

        if (tree.length === 0) {
            grid.className = 'agent-grid';
            grid.innerHTML = `<div style="color:var(--muted); padding:20px; text-align:center; width:100%; grid-column:1/-1;">No agents are currently working.</div>`;
            return;
        }

        if (hasChildren) {
            grid.className = 'agent-grid tree-view';
            grid.innerHTML = tree.map(node => {
                let html = `<div class="tree-node">${agentCardHTML(node, true)}`;
                if (node.children.length > 0) {
                    html += `<div class="tree-children">${node.children.map(c => agentCardHTML(c, false)).join('')}</div>`;
                }
                return html + '</div>';
            }).join('');
        } else {
            grid.className = 'agent-grid';
            grid.innerHTML = tree.map(node => agentCardHTML(node, true)).join('');
        }
    } catch (e) {
        showToast('Agent fleet: ' + e.message, 'error');
        document.getElementById('agent-grid').innerHTML = `<div style="color:var(--error); padding:20px; text-align:center; width:100%; grid-column:1/-1;">Error: ${escapeHtml(e.message)}</div>`;
    }
}

const REFRESH_INTERVAL = 30;
let nextRefresh = Date.now() + REFRESH_INTERVAL * 1000;
let openProjects = new Set();

function toggleProjectAccordion(projectName) {
    if (openProjects.has(projectName)) {
        openProjects.delete(projectName);
    } else {
        openProjects.add(projectName);
    }
    const projectDiv = document.getElementById("project-" + projectName.replace(/[^a-zA-Z0-9]/g, ""));
    if (projectDiv) {
        projectDiv.classList.toggle("active");
    }
}

function fmtTime(d) {
    return new Date(d).toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit'});
}

function fmtDuration(sinceStr) {
    if (!sinceStr) return '--';
    try {
        const cleaned = sinceStr.replace(/^[A-Za-z]+\s+/, '');
        const d = new Date(cleaned);
        if (isNaN(d.getTime())) return sinceStr;
        const secs = Math.floor((Date.now() - d.getTime()) / 1000);
        if (secs < 0) return sinceStr;
        const days = Math.floor(secs / 86400);
        const hrs = Math.floor((secs % 86400) / 3600);
        const mins = Math.floor((secs % 3600) / 60);
        if (days > 0) return `${days}d ${hrs}h ${mins}m`;
        if (hrs > 0) return `${hrs}h ${mins}m`;
        return `${mins}m`;
    } catch(e) { return sinceStr; }
}

function escapeHtml(v) {
    return String(v ?? '').replace(/[&<>'"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[ch]));
}

function fmtCost(v) {
    if (v === undefined || v === null) return '--';
    if (v === 0) return '$0.00';
    if (v < 0.01 && v > 0) return '<$0.01';
    return '$' + v.toFixed(2);
}

function fmtTokens(v) {
    if (!v) return '0';
    if (v >= 1000000) return (v / 1000000).toFixed(1) + 'M';
    if (v >= 1000) return Math.round(v / 1000) + 'K';
    return String(v);
}

function fmtAge(ms) {
    if (!ms && ms !== 0) return '--';
    if (ms < 60000) return Math.floor(ms / 1000) + 's ago';
    if (ms < 3600000) return Math.floor(ms / 60000) + 'm ago';
    if (ms < 86400000) return Math.floor(ms / 3600000) + 'h ago';
    return Math.floor(ms / 86400000) + 'd ago';
}

let _rawMemoryContent = '';

function filterMemory() {
    const query = (document.getElementById('mem-search').value || '').trim();
    const el = document.getElementById('memory-content');
    const countEl = document.getElementById('mem-count');
    if (!el || !_rawMemoryContent) return;

    if (!query) {
        el.textContent = _rawMemoryContent;
        if (countEl) countEl.style.display = 'none';
        return;
    }

    const lines = _rawMemoryContent.split('\n');
    const re = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    const matched = lines.filter(l => re.test(l));
    re.lastIndex = 0;

    if (matched.length === 0) {
        el.innerHTML = `<span style="color:var(--muted);opacity:.6">No lines matching "${escapeHtml(query)}"</span>`;
        if (countEl) { countEl.textContent = `0 / ${lines.length} lines`; countEl.style.display = 'block'; }
        return;
    }

    el.innerHTML = matched.map(line => {
        return escapeHtml(line).replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), m => `<span class="mem-highlight">${m}</span>`);
    }).join('\n');
    if (countEl) { countEl.textContent = `${matched.length} / ${lines.length} lines`; countEl.style.display = 'block'; }
}

let _dismissedAlerts = new Map();
let _lastIssues = [];
const DISMISS_TTL = 86400000;

function loadDismissed() {
    try {
        const raw = JSON.parse(localStorage.getItem('homie-dismissed-alerts') || '[]');
        const now = Date.now();
        _dismissedAlerts.clear();
        for (const entry of raw) {
            if (typeof entry === 'string') { _dismissedAlerts.set(entry, now); }
            else if (entry.m && entry.t && now - entry.t < DISMISS_TTL) { _dismissedAlerts.set(entry.m, entry.t); }
        }
        saveDismissed();
    } catch(e) { _dismissedAlerts.clear(); }
}

function saveDismissed() {
    const arr = []; _dismissedAlerts.forEach((t, m) => arr.push({m, t}));
    localStorage.setItem('homie-dismissed-alerts', JSON.stringify(arr));
}

function dismissAlert(msg) {
    _dismissedAlerts.set(msg, Date.now());
    saveDismissed();
    renderAlerts();
}

function clearAllAlerts() {
    const now = Date.now();
    _lastIssues.forEach(i => _dismissedAlerts.set(i.message, now));
    saveDismissed();
    renderAlerts();
}

function resetAlerts() {
    _dismissedAlerts.clear();
    saveDismissed();
    renderAlerts();
}

function renderAlerts() {
    const iel = document.getElementById('issues');
    const ctrl = document.getElementById('alerts-controls');
    if (!iel) return;

    const all = _lastIssues;
    const visible = all.filter(i => !_dismissedAlerts.has(i.message));
    const cleared = all.length - visible.length;

    let ctrlHtml = '';
    if (cleared > 0) {
        ctrlHtml += `<span style="font-size:11px;color:var(--muted)">${cleared} cleared</span>`;
        ctrlHtml += `<button class="btn" style="font-size:10px;padding:2px 8px" onclick="resetAlerts()">Show all</button>`;
    }
    if (visible.length > 0) {
        ctrlHtml += `<button class="btn" style="font-size:10px;padding:2px 8px" onclick="clearAllAlerts()">Clear all</button>`;
    }
    if (ctrl) ctrl.innerHTML = ctrlHtml;

    if (all.length === 0 && cleared === 0) {
        iel.innerHTML = '<div class="nominal" style="grid-column:1/-1">All systems nominal</div>';
    } else if (visible.length === 0) {
        iel.innerHTML = `<div class="nominal" style="grid-column:1/-1">All alerts cleared</div>`;
    } else {
        iel.innerHTML = visible.map(i => {
            const isErr = i.level === 'error';
            const icon = isErr ? '\u2715' : '\u26A0';
            const label = isErr ? 'Error' : 'Warning';
            return `<div class="alert-card ${escapeHtml(i.level)}">
                <button class="alert-dismiss" data-msg="${escapeHtml(i.message)}" onclick="event.stopPropagation();dismissAlert(this.getAttribute('data-msg'))" title="Dismiss">&times;</button>
                <div class="alert-head">
                    <div class="alert-icon">${icon}</div>
                    <span class="alert-badge">${label}</span>
                </div>
                <div class="alert-msg">${escapeHtml(i.message)}</div>
            </div>`;
        }).join('');
    }
}


const _spark = { cpu: [], ram: [] };
const SPARK_LEN = 20;

function sparkSVG(data, color, maxVal) {
    if (data.length < 2) return '';
    const w = 60, h = 16, max = maxVal || Math.max(...data, 1);
    const step = w / (data.length - 1);
    const pts = data.map((v, i) => `${(i * step).toFixed(1)},${(h - (v / max) * (h - 2) - 1).toFixed(1)}`);
    return `<svg class="spark" viewBox="0 0 ${w} ${h}" width="60" height="16"><polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

async function get(endpoint) {
    try {
        const res = await fetch(API_BASE + '/' + endpoint);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        return await res.json();
    } catch(e) {
        showToast(`Failed to fetch ${endpoint.split('?')[0]}`, 'error');
        return {};
    }
}

async function post(endpoint, body) {
    try {
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body || {})
        });
        return await res.json();
    } catch(e) {
        showToast(`Request failed: ${e.message}`, 'error');
        return { ok: false, error: e.message };
    }
}

async function load() {
    document.body.style.opacity = '0.7';
    if (currentTab === 'agents') loadAgents();
    if (currentTab === 'ops') loadOps();
    const [s, m, p, sk, mem, is, td, ac, gw] = await Promise.all([
        get('status'), get('monitor'), get('providers'), get('skills'), get('memory'), get('issues'), get('todos'), get('actions'), get('gateway-health')
    ]);

    try {
        _spark.cpu.push(s.cpu_percent || 0);
        if (_spark.cpu.length > SPARK_LEN) _spark.cpu.shift();
        _spark.ram.push(s.ram_gb || 0);
        if (_spark.ram.length > SPARK_LEN) _spark.ram.shift();

        document.getElementById('cpu').innerHTML = escapeHtml((s.cpu_percent ?? '--') + '%') + sparkSVG(_spark.cpu, 'var(--cyan)', 100);
        document.getElementById('ram').innerHTML = escapeHtml((s.ram_gb ?? '--') + ' / ' + (s.ram_total_gb ?? '--') + ' GB') + sparkSVG(_spark.ram, 'var(--purple)', s.ram_total_gb || 16);
        document.getElementById('disk').textContent = (escapeHtml(s.disk_gb) || '--') + ' / ' + (escapeHtml(s.disk_total_gb) || '--') + ' GB';
        document.getElementById('uptime').textContent = escapeHtml(s.uptime) || '--';
    } catch(e) { console.error('Status panel:', e); }

    try {
        const gwStatus = gw.status || 'unknown';
        const gwStatusClass = 'st-' + gwStatus.replace(/[^a-z]/g, '');
        document.getElementById('gw-pulse').className = 'pulse ' + (gwStatus === 'active' ? 'green' : (gwStatus === 'unknown' ? '' : 'amber'));
        document.getElementById('gw-health').innerHTML =
            `<div class="gw-metric"><div class="gw-lbl">Status</div><div class="gw-val ${gwStatusClass}">${escapeHtml(gwStatus)}</div></div>` +
            `<div class="gw-metric"><div class="gw-lbl">Restarts</div><div class="gw-val" style="color:${(gw.restarts||0) > 0 ? 'var(--warn)' : 'var(--cyan)'}">${escapeHtml(gw.restarts ?? '--')}</div></div>` +
            `<div class="gw-metric"><div class="gw-lbl">Uptime</div><div class="gw-val" style="color:var(--text);font-size:14px">${fmtDuration(gw.active_since)}</div></div>` +
            `<div class="gw-metric"><div class="gw-lbl">Last Probe</div><div class="gw-val" style="color:var(--text);font-size:14px">${gw.last_probe ? fmtTime(gw.last_probe) : '--'}</div></div>`;
    } catch(e) { console.error('Gateway panel:', e); }

    try {
        document.getElementById('monitor-pulse').className = 'pulse ' + ((m.lastRateLimitCount||0)>0 ? 'amber' : 'green');
        document.getElementById('last-check').textContent = m.lastCheckAt ? fmtTime(m.lastCheckAt) : 'Never';
        document.getElementById('rate-limits').textContent = escapeHtml(m.lastRateLimitCount) || 0;
        document.getElementById('rate-limits').className = 'val ' + ((m.lastRateLimitCount||0)>0 ? 'error' : '');
        document.getElementById('last-alert').textContent = m.lastAlertAt ? fmtTime(m.lastAlertAt) : 'None';
    } catch(e) { console.error('Monitor panel:', e); }

    try {
        const providers = p.providers || [];
        document.getElementById('providers').innerHTML = providers.length
          ? providers.map(x => {
              const safeStatus = x.status === 'ok' ? 'ok' : 'missing';
              return `<div class="provider"><span class="provider-name">${escapeHtml(x.name)}</span>
                <div style="display:flex;align-items:center"><span class="provider-msg">${escapeHtml(x.message)}</span><span class="badge ${safeStatus}">${escapeHtml(x.status || 'unknown')}</span></div></div>`;
            }).join('')
          : '<div class="nominal">No providers detected</div>';
    } catch(e) { console.error('Providers panel:', e); }

    try {
        const skills = sk.skills || [];
        document.getElementById('skills').innerHTML = skills.length
          ? skills.map(x =>
            `<div class="skill ${x.installed?'installed':'missing'}" title="${escapeHtml(x.description||'')}">${escapeHtml(x.name)}</div>`
          ).join('')
          : '<div class="nominal">No skills data</div>';
    } catch(e) { console.error('Skills panel:', e); }

    try {
        document.getElementById('mem-date').textContent = mem.date ? '(' + mem.date + ')' : '';
        _rawMemoryContent = mem.content || 'No memory files';
        document.getElementById('memory-content').textContent = _rawMemoryContent;
        filterMemory();
        document.getElementById('date-chips').innerHTML = (mem.all_dates||[]).map(d =>
            `<div class="chip ${d===mem.date?'active':''}" data-date="${escapeHtml(d)}" onclick="switchMem(this.getAttribute('data-date'), this)">${escapeHtml(d)}</div>`
        ).join('');
    } catch(e) { console.error('Memory panel:', e); }

    try {
        _lastIssues = is.issues || [];
        renderAlerts();
    } catch(e) { console.error('Alerts panel:', e); }

    try {
        const actions = ac.actions || [];
        document.getElementById('action-grid').innerHTML = actions.length
          ? actions.map(a => `<button class="action-btn" ${a.cooldown_left > 0 ? 'disabled' : ''} onclick="confirmAction('${escapeHtml(a.id)}','${escapeHtml(a.label)}')">${escapeHtml(a.label)}${a.cooldown_left > 0 ? `\n(cooldown: ${escapeHtml(a.cooldown_left)}s)` : ''}</button>`).join('')
          : '<div class="nominal">No actions configured</div>';
    } catch(e) { console.error('Actions panel:', e); }

    try {
        document.getElementById('todo-summary').textContent = `${escapeHtml(td.done) || 0} / ${escapeHtml(td.total) || 0} done`;
        document.getElementById('todo-percent').textContent = `${escapeHtml(td.percent) || 0}%`;
        document.getElementById('todo-fill').style.width = `${escapeHtml(td.percent) || 0}%`;
        const tel = document.getElementById('todo-list');
        const projects = td.projects || [];
        tel.innerHTML = projects.length
          ? projects.map(p => `
            <div class="todo-project ${openProjects.has(p.name) ? 'active' : ''}" id="project-${p.name.replace(/[^a-zA-Z0-9]/g, '')}">
              <div class="todo-project-head" onclick="toggleProjectAccordion('${p.name}')">
                <div class="todo-project-name"><span class="accordion-icon">&#9654;</span> ${escapeHtml(p.name)}</div>
                <div class="todo-project-meta">${escapeHtml(p.done)}/${escapeHtml(p.total)} &bull; ${escapeHtml(p.percent)}%</div>
              </div>
              <div class="todo-items">
                ${(p.items||[]).map(t => `<div class="todo-item ${t.done ? 'done' : ''}"><label style="display:flex;gap:8px;align-items:flex-start;cursor:pointer;"><input type="checkbox" ${t.done ? 'checked' : ''} data-path="${escapeHtml(p.path)}" data-lineno="${t.line_no ?? -1}" data-done="${t.done ? 'true' : 'false'}" onchange="toggleTodo(this.getAttribute('data-path'), parseInt(this.getAttribute('data-lineno'), 10), this.getAttribute('data-done') === 'true')" /> <span>${escapeHtml(t.text)}</span></label></div>`).join('')}
              </div>
            </div>
          `).join('')
          : '<div class="nominal">No TODO items found in project TODO.md files</div>';
    } catch(e) { console.error('Todos panel:', e); }

    document.getElementById('last-refresh').textContent = fmtTime(new Date());
    nextRefresh = Date.now() + REFRESH_INTERVAL * 1000;
    document.body.style.opacity = '1';
}

function renderCostChart(days) {
    const el = document.getElementById('cost-chart');
    if (!el) return;
    if (!days || days.length === 0) {
        el.innerHTML = '<div class="chart-empty">No cost history yet</div>';
        return;
    }

    const recent = days.slice(-30);
    const maxCost = Math.max(...recent.map(d => d.cost || 0), 0.01);
    const W = 800, H = 160, padL = 45, padR = 10, padT = 10, padB = 28;
    const chartW = W - padL - padR, chartH = H - padT - padB;
    const barW = Math.max(Math.floor(chartW / recent.length) - 2, 4);
    const gap = (chartW - barW * recent.length) / Math.max(recent.length - 1, 1);

    let gridLines = '';
    const gridSteps = 4;
    for (let i = 0; i <= gridSteps; i++) {
        const y = padT + (chartH / gridSteps) * i;
        const val = maxCost - (maxCost / gridSteps) * i;
        gridLines += `<line x1="${padL}" y1="${y}" x2="${W - padR}" y2="${y}" class="chart-gridline"/>`;
        gridLines += `<text x="${padL - 4}" y="${y + 3}" class="chart-label" text-anchor="end">$${val < 1 ? val.toFixed(2) : val.toFixed(1)}</text>`;
    }

    let bars = '', labels = '';
    recent.forEach((d, i) => {
        const x = padL + i * (barW + gap);
        const h = chartH * Math.min((d.cost || 0) / maxCost, 1);
        const y = padT + chartH - h;
        const color = (d.cost || 0) > maxCost * 0.8 ? 'var(--warn)' : 'var(--cyan)';
        bars += `<rect class="chart-bar" x="${x}" y="${y}" width="${barW}" height="${Math.max(h, 1)}" rx="2" fill="${color}" data-idx="${i}"/>`;
        if (recent.length <= 15 || i % Math.ceil(recent.length / 10) === 0 || i === recent.length - 1) {
            const lbl = (d.date || '').slice(5);
            labels += `<text x="${x + barW / 2}" y="${H - 4}" class="chart-label" text-anchor="middle">${lbl}</text>`;
        }
    });

    el.innerHTML = `<div class="chart-wrap">
        <div class="chart-tooltip" id="chart-tip"></div>
        <svg class="chart-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">${gridLines}${bars}${labels}</svg>
    </div>`;

    const svg = el.querySelector('.chart-svg');
    const tip = document.getElementById('chart-tip');
    if (svg && tip) {
        svg.addEventListener('mousemove', (ev) => {
            const bar = ev.target.closest('.chart-bar');
            if (!bar) { tip.classList.remove('visible'); return; }
            const idx = parseInt(bar.dataset.idx);
            const d = recent[idx];
            if (!d) return;
            tip.innerHTML = `<div class="chart-tooltip-date">${escapeHtml(d.date)}</div><div class="chart-tooltip-val">${fmtCost(d.cost)}</div><div class="chart-tooltip-tok">${fmtTokens(d.tokens)} tokens &middot; ${d.sessions || 0} sessions</div>`;
            const rect = el.querySelector('.chart-wrap').getBoundingClientRect();
            const bRect = bar.getBoundingClientRect();
            tip.style.left = (bRect.left - rect.left + bRect.width / 2) + 'px';
            tip.style.top = (bRect.top - rect.top - 60) + 'px';
            tip.classList.add('visible');
        });
        svg.addEventListener('mouseleave', () => tip.classList.remove('visible'));
    }
}

async function loadOps() {
    const [costs, rl, crons, feed, costHist] = await Promise.all([
        get('costs'), get('rate-limits'), get('crons'), get('feed'), get('cost-history')
    ]);

    try {
        document.getElementById('cost-today').textContent = fmtCost(costs.today_cost);
        document.getElementById('cost-today-tok').textContent = costs.today_tokens ? fmtTokens(costs.today_tokens) + ' tokens' : '';
        document.getElementById('cost-alltime').textContent = fmtCost(costs.alltime_cost);
        document.getElementById('cost-alltime-tok').textContent = costs.alltime_tokens ? fmtTokens(costs.alltime_tokens) + ' tokens' : '';
        document.getElementById('cost-monthly').textContent = fmtCost(costs.projected_monthly);
        document.getElementById('cost-sessions').textContent = costs.session_count ? costs.session_count + ' sessions' : '';

        const models = costs.models || [];
        document.getElementById('model-breakdown').innerHTML = models.length
          ? `<table class="model-table"><thead><tr><th>Model</th><th>Tokens</th><th>Sessions</th><th>Est. Cost</th></tr></thead><tbody>${
              models.map(m => `<tr><td class="mn">${escapeHtml(m.model)}</td><td>${fmtTokens(m.tokens)}</td><td>${m.sessions}</td><td>${fmtCost(m.cost)}</td></tr>`).join('')
            }</tbody></table>`
          : '<div class="nominal">No model data available</div>';
    } catch(e) { console.error('Costs panel:', e); }

    try {
        renderCostChart((costHist.days || []).slice(-30));
    } catch(e) { console.error('Cost chart:', e); }

    try {
        const limits = rl.limits || [];
        document.getElementById('rate-limits-panel').innerHTML = limits.length
          ? limits.map(l => {
              const cls = l.percent > 80 ? 'danger' : (l.percent > 60 ? 'warn' : 'ok');
              return `<div class="gauge">
                  <div class="gauge-head"><span class="gauge-provider">${escapeHtml(l.provider)}</span><span class="gauge-pct">${l.percent}%</span></div>
                  <div class="gauge-bar"><div class="gauge-fill ${cls}" style="width:${Math.min(l.percent, 100)}%"></div></div>
                  <div class="gauge-meta">${l.used} / ${l.limit || '?'} &middot; window: ${escapeHtml(l.window)}</div>
              </div>`;
            }).join('')
          : '<div class="nominal">No rate limit data</div>';
    } catch(e) { console.error('Rate limits panel:', e); }

    try {
        const jobs = crons.crons || [];
        document.getElementById('cron-panel').innerHTML = jobs.length
          ? jobs.map(c => `<div class="cron-card">
              <div class="cron-dot ${escapeHtml(c.status)}"></div>
              <div class="cron-info">
                  <div class="cron-name">${escapeHtml(c.name)}</div>
                  <div class="cron-meta">${escapeHtml(c.model)} &middot; ${fmtAge(c.last_run_ms)} &middot; ${fmtTokens(c.tokens)} tok</div>
              </div>
            </div>`).join('')
          : '<div class="nominal">No cron jobs found</div>';
    } catch(e) { console.error('Crons panel:', e); }

    try {
        const entries = feed.entries || [];
        if (!entries.length) {
            document.getElementById('feed-panel').innerHTML = '<div class="nominal">No recent activity</div>';
        } else {
            let html = '', lastDate = '';
            for (const e of entries) {
                if (e.date !== lastDate) {
                    html += `<div class="feed-date">${escapeHtml(e.date)}</div>`;
                    lastDate = e.date;
                }
                html += `<div class="feed-entry">
                    <span class="feed-dot ${escapeHtml(e.color || 'cyan')}"></span>
                    <span class="feed-msg">${escapeHtml(e.message)}</span>
                </div>`;
            }
            document.getElementById('feed-panel').innerHTML = html;
        }
    } catch(e) { console.error('Feed panel:', e); }
}

async function switchMem(date, el) {
    const d = await get('memory?date=' + encodeURIComponent(date));
    _rawMemoryContent = d.content || 'No data';
    document.getElementById('memory-content').textContent = _rawMemoryContent;
    filterMemory();
    document.getElementById('mem-date').textContent = '(' + (d.date||'') + ')';
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    if (el) el.classList.add('active');
}

async function toggleTodo(path, lineNo, currentDone) {
    try {
        const r = await post(API_BASE + '/todos/toggle', { path, line_no: lineNo, done: !currentDone });
        if (!r.ok) {
            showToast('Todo update failed: ' + (r.error || 'unknown error'), 'warn');
            return;
        }
        await load();
    } catch (e) {
        showToast('Todo update failed: ' + e.message, 'error');
    }
}

async function runAction(actionId) {
    const out = document.getElementById('action-result');
    out.textContent = `Running ${actionId} ...`;
    try {
        const r = await post(API_BASE + '/actions/run', { action: actionId });
        if (!r.ok) {
            out.textContent = `[FAIL] ${r.label || actionId}\nerror: ${r.error || 'unknown'}\n${r.stderr || ''}`.trim();
            await load();
            return;
        }
        const summary = [
            `[OK] ${r.label || actionId}`,
            `exit: ${r.exit_code}`,
            r.stdout ? `stdout:\n${r.stdout}` : '',
            r.stderr ? `stderr:\n${r.stderr}` : '',
        ].filter(Boolean).join('\n\n');
        out.textContent = summary;
        await load();
    } catch (e) {
        out.textContent = `[FAIL] ${actionId}\n${e.message}`;
    }
}

function updateAgentBadge() {
    try {
        fetch(API_BASE + '/agents').then(r => r.json()).then(r => {
            if (!r.ok || !r.sessions) return;
            const active = r.sessions.filter(s => !(s.key||'').includes('cron:') && (s.ageMs < 120000 || s.abortedLastRun)).length;
            const badge = document.getElementById('agent-badge');
            if (!badge) return;
            if (active > 0) { badge.textContent = active; badge.style.display = 'flex'; }
            else { badge.style.display = 'none'; }
        }).catch(() => {});
    } catch(e) {}
}
function updateOpsBadge() {
    try {
        fetch(API_BASE + '/rate-limits').then(r => r.json()).then(r => {
            const badge = document.getElementById('ops-badge');
            if (!badge) return;
            const limits = r.limits || [];
            const warnings = limits.filter(l => l.percent > 60).length;
            if (warnings > 0) {
                const maxPct = Math.max(...limits.map(l => l.percent));
                const danger = maxPct > 80;
                badge.textContent = Math.round(maxPct) + '%';
                badge.style.display = 'flex';
                badge.style.background = danger ? 'var(--error)' : 'var(--warn)';
                badge.style.boxShadow = '0 0 6px ' + (danger ? 'var(--error)' : 'var(--warn)');
            } else { badge.style.display = 'none'; }
        }).catch(() => {});
    } catch(e) {}
}

setInterval(updateAgentBadge, 30000);
setInterval(updateOpsBadge, 30000);
setTimeout(updateAgentBadge, 2000);
setTimeout(updateOpsBadge, 2500);

let _refreshInterval = setInterval(load, REFRESH_INTERVAL * 1000);
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(_refreshInterval);
        _refreshInterval = null;
    } else {
        load();
        _refreshInterval = setInterval(load, REFRESH_INTERVAL * 1000);
    }
});

function confirmAction(actionId, label) {
    const overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.innerHTML = `<div class="confirm-box">
        <div class="confirm-title">Confirm Action</div>
        <div class="confirm-msg">Run <strong>${escapeHtml(label)}</strong>?<br>This will affect the live service.</div>
        <div class="confirm-actions">
            <button class="btn" onclick="this.closest('.confirm-overlay').remove()">Cancel</button>
            <button class="btn danger" onclick="this.closest('.confirm-overlay').remove(); runAction('${escapeHtml(actionId)}')">Run</button>
        </div>
    </div>`;
    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    document.body.appendChild(overlay);
}

async function downloadSnapshot() {
    showToast('Gathering snapshot...', 'info');
    try {
        const [status, monitor, providers, skills, issues, todos, actions, gw, costs, crons, rateLimits, feed] = await Promise.all([
            get('status'), get('monitor'), get('providers'), get('skills'),
            get('issues'), get('todos'), get('actions'), get('gateway-health'),
            get('costs'), get('crons'), get('rate-limits'), get('feed')
        ]);
        const snapshot = {
            exported_at: new Date().toISOString(),
            system: status, monitor, providers, skills, issues, todos,
            actions, gateway_health: gw, costs, crons, rate_limits: rateLimits, feed
        };
        const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `homies-snapshot-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Snapshot downloaded', 'info');
    } catch(e) {
        showToast('Snapshot failed: ' + e.message, 'error');
    }
}

initCompact();
initTheme();
loadDismissed();

document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
    switch(e.key) {
        case 'r': case 'R': e.preventDefault(); load(); break;
        case '1': e.preventDefault(); switchTab('overview'); break;
        case '2': e.preventDefault(); switchTab('agents'); break;
        case '3': e.preventDefault(); switchTab('ops'); break;
        case 't': case 'T': e.preventDefault(); toggleTheme(); break;
        case 'c': case 'C': e.preventDefault(); toggleCompact(); break;
        case '?': e.preventDefault(); showToast('Keys: R refresh \u2022 1 overview \u2022 2 agents \u2022 3 ops \u2022 T theme \u2022 C compact', 'info'); break;
    }
});

setInterval(() => {
    document.getElementById('clock').textContent = fmtTime(new Date());
    document.getElementById('countdown').textContent = Math.max(0, Math.ceil((nextRefresh-Date.now())/1000)) + 's';
}, 1000);

load();
</script>
</body>
</html>
